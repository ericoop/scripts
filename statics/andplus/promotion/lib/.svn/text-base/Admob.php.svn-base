<?php
class Admob {
	private $cookie = '/tmp/cookies.txt';
	private $login_url = 'https://accounts.google.com/ServiceLogin?service=admob&hl=en_US&continue=https://www.admob.com/home/login/google?&followup=https://www.admob.com/home/login/google?';
	private $report_url = 'http://www.admob.com/reporting/sites/grid';
	private $index = 'http://www.admob.com/my_sites/';
	private $user_agent = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_1) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.89 Safari/537.1';
	
	private $account = array(
		array('letangpublisher@gmail.com', 'lt@147..'),
		array('letangadmobb@gmail.com', 'letang147'),
		array('letangadmob@gmail.com', 'lt@147258369.'),
		array('letangcontact@gmail.com', 'lt@147..'),
		array('letangcontact5@gmail.com', '13696517869'),
		array('letangcontact4@gmail.com', '13696517869'),
		array('ltophelia@gmail.com', 'lt858891'),
		array('letangpromotion33@gmail.com', 'q1w2e3r4t5..'),
		array('letangpromotion22@gmail.com', '13696517869'),
		array('letangpromotion88@gmail.com', 'q1w2e3r4t5..'),
		array('xiaoyoupi3@gmail.com', '123158705'),
		array('letangadmob68@gmail.com', 'q1w2e3r4t5..'),
		array('letangpromotion12@gmail.com', 'q1w2e3r4t5..'),
		array('letangcontactb@gmail.com', 'emma123456'),
		array('letangcontacta@gmail.com', 'emma123456'),
		array('letangadmoba@gmail.com', 'letang258'),
		array('letangcontact7@gmail.com', ' 13696517869'),
		array('letangadmob5@gmail.com', 'q1w2e3r4t5..'),
		array('letangadmobc@gmail.com', 'letang369')
	);
	
	public function login($username, $passwd) {
		$ch = curl_init();
		curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 30);
		curl_setopt($ch, CURLOPT_USERAGENT, $this->user_agent);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
		curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
		curl_setopt($ch, CURLOPT_COOKIEJAR, $this->cookie);
		curl_setopt($ch, CURLOPT_COOKIEFILE, $this->cookie);
		curl_setopt($ch, CURLOPT_HEADER, 0);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);
		curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 120);
		curl_setopt($ch, CURLOPT_TIMEOUT, 120);
		curl_setopt($ch, CURLOPT_FOLLOWLOCATION,1);
		curl_setopt($ch, CURLOPT_URL, $this->login_url);
		$data = curl_exec($ch);
	
		$formFields = $this->getFormFields($data);
	
		$formFields['Email']  = $username;
		$formFields['Passwd'] = $passwd;
		unset($formFields['PersistentCookie']);
	
		$post_string = '';
		foreach($formFields as $key => $value) {
			$post_string .= $key . '=' . urlencode($value) . '&';
		}
	
		$post_string = substr($post_string, 0, -1);
	
		curl_setopt($ch, CURLOPT_POST, 1);
		curl_setopt($ch, CURLOPT_POSTFIELDS, $post_string);
		
		// why login twice? because the 1st login is to get locale then store to cookie.
		curl_exec($ch);
		$result = curl_exec($ch);
		if($result === false) {
			echo 'Curl error:' . curl_error($ch);
		}
		$this->locale($result);
		return $result;
	}
	
	function fetchReport($ids, $start_date, $end_date) {
// 		$ch = curl_init();
// 		curl_setopt($ch, CURLOPT_URL, "http://SomeDomain/SamplePath");
// 		curl_setopt($ch, CURLOPT_POST, true); // 啟用POST
// 		curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query( array( "a"=>"123", "b"=>"321") ));
// 		curl_exec($ch);
// 		curl_close($ch);
		
	  	$ch = curl_init();
		curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 30);
		curl_setopt($ch, CURLOPT_USERAGENT, $this->user_agent);
	 	curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
		curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
		curl_setopt($ch, CURLOPT_COOKIEJAR, $this->cookie);
		curl_setopt($ch, CURLOPT_COOKIEFILE, $this->cookie);
		curl_setopt($ch, CURLOPT_HEADER, 0);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);
		curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 120);
		curl_setopt($ch, CURLOPT_TIMEOUT, 120);
		curl_setopt($ch, CURLOPT_FOLLOWLOCATION,1);
		curl_setopt($ch, CURLOPT_URL, $this->report_url);
// 		print_r("report_url:");
// 		print_r($this->report_url);
// 		print_r("---\n");
		$formFields['start']  = 0;
		$formFields['limit']  = 25;
		$formFields['object_type']  = 'site';
		$formFields['object_dimension']  = 0;
// 		$formFields['ids[]'] = 'a150065cc8cd666';
// 	  	$formFields['start_date'] = '2012-08-01';
// 	  	$formFields['end_date'] = '2012-08-31';
		$formFields['ids[]'] = $ids;
		$formFields['start_date'] = $start_date;
		$formFields['end_date'] = $end_date;
		$formFields['time_dimension'] = 'day';
		$formFields['selected_type'] = 'cpc';
	
		$post_string = '';
		foreach($formFields as $key => $value) {
			$post_string .= $key . '=' . urlencode($value) . '&';
		}
		$post_string = substr($post_string, 0, -1);
	
		curl_setopt($ch, CURLOPT_POST, 1);
		curl_setopt($ch, CURLOPT_POSTFIELDS, $post_string);
	
		$data =  curl_exec($ch);
		if($data=== false) {
		echo 'Curl error:' . curl_error($ch);
		}
		curl_close($ch);
// 		print_r($data);exit(1);
		return $data;
	}
	
	function fetchAppList() {
		$ch = curl_init();
		curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 30);
		curl_setopt($ch, CURLOPT_USERAGENT, $this->user_agent);
	 	curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
		curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
		curl_setopt($ch, CURLOPT_COOKIEJAR, $this->cookie);
		curl_setopt($ch, CURLOPT_COOKIEFILE, $this->cookie);
		curl_setopt($ch, CURLOPT_HEADER, 0);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);
		curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 120);
		curl_setopt($ch, CURLOPT_TIMEOUT, 120);
		curl_setopt($ch, CURLOPT_FOLLOWLOCATION,1);
		curl_setopt($ch, CURLOPT_URL, $this->index);
		$data = curl_exec($ch);
		preg_match("/<tbody>(.*)<\/tbody>/is", $data, $matches);
		curl_close($ch);
		preg_match_all("/<tr id=(.+?)<br \/>/s", $matches[0], $matches1);
		$rs = null;
		foreach ($matches1[1] as $e) {
			$str = trim(strip_tags($e));
			$str = explode("&nbsp;", $str);
			$key = substr(trim($str[0]), 5, 15);
			$rs[$key] = trim($str[1]); // game name
		}
		return $rs;
	}
	
	function locale ($login_result) {
		preg_match("/location.replace\(\"(.+?)my_sites/is", $login_result, $matches);
		$root = $matches[1];
		$this->index = $root . 'my_sites/';
		$this->report_url = $root . 'reporting/sites/grid';
	}
	
// 	function fetch() {
// 		$ch2 = curl_init();
// 		curl_setopt($ch2, CURLOPT_URL, "http://zhcn.admob.com/my_sites/widgets/revenue/data/?_dc=1346753157248");
// 		curl_setopt($ch2, CURLOPT_URL, "http://www.admob.com/my_sites/widgets/revenue/data/?_dc=1346753157248");
// 	  	curl_setopt($ch2, CURLOPT_HEADER, false);
// 	  	curl_setopt($ch2, CURLOPT_RETURNTRANSFER, 1);
// 		curl_setopt($ch2, CURLOPT_COOKIEFILE, $this->cookie);
// 		$data =  curl_exec($ch2);
// 		unlink($this->cookie);
// 		curl_close($ch2);
// 		return $data;
// 	}
	
	function getFormFields($data) {
		if (preg_match('/(<form.*?id=.?gaia_loginform.*?<\/form>)/is', $data, $matches)) {
	        $inputs = $this->getInputs($matches[1]);
			return $inputs;
		} else {
			die('didnt find login form');
		}
	}

	function getInputs($form) {
		$inputs = array();
    	$elements = preg_match_all('/(<input[^>]+>)/is', $form, $matches);
		if ($elements > 0) {
			for($i = 0; $i < $elements; $i++) {
				$el = preg_replace('/\s{2,}/', ' ', $matches[1][$i]);
	
				if (preg_match('/name=(?:["\'])?([^"\'\s]*)/i', $el, $name)) {
					$name  = $name[1];
					$value = '';
	
					if (preg_match('/value=(?:["\'])?([^"\'\s]*)/i', $el, $value)) {
						$value = $value[1];
					}
	
					$inputs[$name] = $value;
				}
			}
		}

		return $inputs;
	}
			
	public function logOut() {
		unlink($this->cookie);
	}
	
	public function getAccount() {
		return $this->account;
	}
			
	public function test() {
		$username = 'letangcontact5@gmail.com';
		$passwd = '13696517869';
// 		$username = 'letangadmob@gmail.com';
// 		$passwd = 'lt@147258369.';
		$this->login($username, $passwd);
		$data = $this->fetchAppList();
		print_r($data);
// 		return;
		
		
// 		print_r($data);
		foreach ($data as $key => $e) {
			$d = $this->fetchReport($key, '2012-08-01', '2012-08-31');
			print_r($d);
			print_r("\n");
		}
		
		$this->logOut();
	}
	
}

