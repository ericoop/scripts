<?php
class JoyDb {
	private static $conn = null;

	public static function init() {
		$opt = array (PDO::ATTR_PERSISTENT => true);
		$setting = include 'foo.php';
		self::$conn = new PDO ($setting['mysql'][0], $setting['mysql'][1], $setting['mysql'][2], $opt);
    }

	/**
	 * @return PDO
	 */
	public static function getInstance() {
        if (self::$conn === null) {
            self::init();
        }
        return self::$conn;
    }

    public static function getDb($dbName) {
    	return new PDO ("mysql:host=61.190.43.2;dbname=${dbName}", 'pwd', 'pwd');
    }
    
    static function exception($stmt) {
    	$info_array = $stmt->errorInfo();
    	throw new Exception("PDO ERROR: " . $info_array[2]);
    }
    
    public static function query($sql, $params = null, $conn = null) {
    	$conn || $conn = self::getInstance();
    	$stmt = $conn->prepare($sql);
//     	$params = array(1);
    	if($stmt->execute($params)) {
    		$result = $stmt->fetchAll(PDO::FETCH_ASSOC); //fetchAll
    		return $result;
    	} else {
    		self::exception($stmt);
    	}
    }
    
    //sample,  cannot callerd!
	/*    
    function insert() {
    	$conn = JoyDb::getInstance();
    	$sql = "insert into tab_name (column_1, column_2) values(?, ?)";
    	$stmt = $conn->prepare($sql);
    	$params = array(1, "a");
    	if($stmt->execute($params)) {
    		echo $conn->lastInsertId();//如果想取自增长id
    	} else {
    		JoyDb::exception($stmt);
    	}
    	
    }
    
	function update() {
		$conn = JoyDb::getInstance();
		$sql = "update tab_name set col1 = ?, col2 = ? where id = ?";
		$stmt = $conn->prepare($sql);
		$params = array(2, "b", 1);
		if($stmt->execute($params)) {
			return true;
		} else {
			JoyDb::exception($stmt);
		}
	}
	
	function query() {
		$sql = "select col1, col2 from tab_name where id = ? ";
		$conn = JoyDb::getInstance();
		$stmt = $conn->prepare($sql);
		$params = array(1);
		if($stmt->execute($params)) {
			//$result = $stmt->fetch(PDO::FETCH_ASSOC); //fetchOne
			$result = $stmt->fetchAll(PDO::FETCH_ASSOC); //fetchAll
			print_r($result);
		} else {
			JoyDb::exception($stmt);
		}
			
	}
    
	public function delete() {
		$conn = JoyDb::getInstance();
		$sql = "delete from tab_name where id = ?";
		$stmt = $conn->prepare($sql);
		$params = array(1);
		if($stmt->execute($params)) {
			return true;
		} else {
			JoyDb::exception($stmt);
		}
	}
    */
}
